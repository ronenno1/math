<?php   
require_once './classes/autoload.php';
$csv_file = isset($_FILES["fileToUpload"]) ? $_FILES["fileToUpload"] :'';
if($csv_file && sizeof($csv_file))
    
    {move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], 'csv/tmp.csv');
    $csv = array_map('str_getcsv', file('csv/tmp.csv'));
//    unlink('csv/tmp.csv');
    //echo "<pre>";
    for($i=2; $i<sizeof($csv); $i++)
    {
        $start_time = $csv[$i][5];
        $email = $csv[$i][3];
        $time = $start_time;
        for($session = 0; $session<2; $session++)
        {
            $code = sha1("$email*$session*a*$start_time");
            $query = "INSERT INTO codes SET start_time=DATE_ADD('".dblayer::clean(date("Y-m-d H:i:s", strtotime($start_time)))."', INTERVAL $session WEEK), email='".dblayer::clean($email)."', code='".dblayer::clean($code)."', session_number = '".  intval($session+1)."'";
echo $query;
            $code_id = dblayer::get_row_query_insert($query);
        }    
    }
    header('location: participants.php');
}
?>
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<script src="./js/general.js"></script>
                <script src="./js/participants.js"></script>
                <link rel="stylesheet" href="style.css">
	</head>
	<body dir = rtl>


            <div id="inst">
                
                <p align="center" class="h1">

שלום, אנא בחר/י את התרגילים המבוקשים ולאחר מכן הקש על "המשך"
                </p>
                <form action="./" method="get">
  <fieldset>

                    <table>

                        <tr>
                            <th><strong>חיבור</strong></th>
                            <td>
                                <select  name="add">
                                    <option value="0">
                                        ללא
                                    </option>
                                    <option value="1">
                                        קטן
                                    </option>
                                    <option value="2">
                                        בינוני
                                    </option>
                                    <option value="3">
                                        גדול
                                    </option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>
                            <strong>חיסור</strong>
                            </th>
                            <td>
                                <select  name="sub">
                                    <option value="0">
                                        ללא
                                    </option>
                                    <option value="1">
                                        קטן
                                    </option>
                                    <option value="2">
                                        בינוני
                                    </option>
                                    <option value="3">
                                        גדול
                                    </option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th><strong>כפל</strong></th>
                            <td>
                                <select name="mult">
                                    <option value="0">
                                        ללא
                                    </option>
                                    <option value="1">
                                        קטן
                                    </option>
                                    <option value="2">
                                        בינוני
                                    </option>
                                    <option value="3">
                                        גדול
                                    </option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th><strong>חילוק</strong></th>
                            <td>
                                <select name="frec">
                                    <option value="0">
                                        ללא
                                    </option>
                                    <option value="1">
                                        קטן
                                    </option>
                                    <option value="2">
                                        בינוני
                                    </option>
                                    <option value="3">
                                        גדול
                                    </option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th><strong>אפסים</strong></th>
                            <td>
                                <select  name="zeros">
                                    <option value="0">
                                        ללא
                                    </option>
                                    <option value="1">
                                        עם
                                    </option>
                                </select>
                            </td>
                        </tr>
                    </table>
      <button>המשך</button>
        </fieldset>

  </form>
            </div>
            <div class="box">

                <h1>Add participants</h1>
<!--                <div class='row'>
                    <div class="form-inline row-sm-1"><label><input placeholder="email" class="form-control" type="email" id = "email"></label></div>
                    <br><div class="form-inline row-sm-1"><label><input type="number"   min="1" placeholder="number of sessions" value="" id="num_of_sessions" class="form-control"/></label></div>
                </div>-->

<form action="" method="post" enctype="multipart/form-data">
    <input style="width: 300px; margin:auto" type="file" name="fileToUpload" id="fileToUpload" accept=".csv">
    <!--<input type="submit" value="Upload CSV" name="submit">-->
    <button  class="btn btn-primary">Add</button>
</form>
    <a href="participants.php"><button class="btn btn-default btn_back">back</button></a>
                <div id="message" class="bg-success"></div>
               <div id="errors" class="bg-danger"></div>

            </div>

  </div>

	</body>
</html>
