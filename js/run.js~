var first_stimolates	= 0;
var total_words			= 0;
var select_ratio		= 0;
var stimulates			= [];
var stimulate_index		= 0;
var response_index		= 0;
var select_answer		= false;
var answers				= [];
var changed				= false;
var stt					= 0;
var ret					= 0;
var set					= 0;


$(document).ready(function()
{
	stt = $.now();
	console.log("start: "+stt);
	$('#inp').val("").focus();
	
	//first character
	$('#inp').keypress(function(e){keypress_action(e);});
	//send answer
	$('#send').click(function(){send_answer();});
});

function init_next()
{
	console.log(answers);
	if(stimulate_index + response_index >= total_words)
	{
		$('.container').html("<h1>that's it</h1>");
		return;
	}
	$('#inp').removeClass('empty');
	$('#inp').val("").focus();
	if(stimulate_index<first_stimolates){
		$('#changeit').html(stimulates[stimulate_index]);
		stimulate_index++;
	}
	else{
		select_answer = (Math.random() < select_ratio/100) ? true : false;
		if((stimulate_index>=stimulates.length || select_answer) && response_index<answers.length){
			$('#changeit').html(answers[response_index]);
			response_index++;
		}
		else{
			$('#changeit').html(stimulates[stimulate_index]);
			stimulate_index++;
		}
	}
}

function keypress_action(e){
	$('#inp').removeClass('empty');
		if(!changed){
			ret = $.now();
			console.log("first change: "+ret);
			changed = true;
		}
		if(e.which == 13)
			$('#send').click();
}

function send_answer()
{
	if(!$('#inp').val()){
			$('#inp').addClass('empty').focus();
			return;
	}
	set = $.now();
	console.log("sent: "+set);
	send_respons(stt, ret, set, select_answer);

	if($.inArray($('#inp').val(), answers) == -1) 
		answers.push($('#inp').val());

	// init next
	init_next();
	changed = false;
	stt = $.now();
	console.log("start: "+stt);
}

function send_respons(stt, ret, set, is_answer){
	var stimulate	= $('#changeit').html();
	var answer		= $('#inp').val();
	
	$.post('./rpc/run.rpc.php',
		{action: 'send_answer',
			stimulate: stimulate,
			answer: answer,
			is_answer: is_answer,
			stt: stt,
			ret: ret,
			set: set
			},
		function(ret){
/// TODO
		});	
}
